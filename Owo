import discord
from discord.ext import commands
import os
import random
from dotenv import load_dotenv

# ====================================================
# ENV AYARLARI
# ====================================================
load_dotenv()
TOKEN = os.getenv("DISCORD_TOKEN")

intents = discord.Intents.all()
bot = commands.Bot(command_prefix="!", intents=intents)

# ====================================================
# LEVEL SÄ°STEMÄ°
# ====================================================
user_xp = {}

@bot.event
async def on_message(message):
    if message.author.bot:
        return

    uid = message.author.id
    user_xp[uid] = user_xp.get(uid, 0) + random.randint(5, 15)

    level = int(user_xp[uid] ** 0.25)
    if user_xp[uid] % 100 == 0:
        await message.channel.send(f"ğŸ”¥ {message.author.mention} **level {level}** olduuu!!")

    await bot.process_commands(message)

@bot.command()
async def level(ctx, member: discord.Member = None):
    member = member or ctx.author
    xp = user_xp.get(member.id, 0)
    lvl = int(xp ** 0.25)
    await ctx.send(f"{member.mention} **Level:** {lvl} | **XP:** {xp}")

# ====================================================
# EKONOMÄ° SÄ°STEMÄ°
# ====================================================
user_money = {}

@bot.command()
async def para(ctx):
    money = user_money.get(ctx.author.id, 0)
    await ctx.send(f"{ctx.author.mention}, hesabÄ±nda **{money}ğŸ’°** var.")

@bot.command()
async def Ã§alÄ±ÅŸ(ctx):
    kazanÃ§ = random.randint(50, 200)
    user_money[ctx.author.id] = user_money.get(ctx.author.id, 0) + kazanÃ§
    await ctx.send(f"ğŸ’¼ Ã‡alÄ±ÅŸtÄ±n ve **{kazanÃ§}ğŸ’°** kazandÄ±n!")

# ====================================================
# MODERASYON KOMUTLARI
# ====================================================
@bot.command()
@commands.has_permissions(kick_members=True)
async def kick(ctx, member: discord.Member, *, sebep="Sebep belirtilmedi"):
    await member.kick(reason=sebep)
    await ctx.send(f"ğŸ¦µ {member} sunucudan atÄ±ldÄ±!")

@bot.command()
@commands.has_permissions(ban_members=True)
async def ban(ctx, member: discord.Member, *, sebep="Sebep belirtilmedi"):
    await member.ban(reason=sebep)
    await ctx.send(f"ğŸ”¨ {member} sunucudan banlandÄ±!")

@bot.command()
@commands.has_permissions(manage_messages=True)
async def sil(ctx, miktar: int):
    await ctx.channel.purge(limit=miktar)
    await ctx.send(f"ğŸ§¹ {miktar} mesaj temizlendi!", delete_after=3)

# ====================================================
# DM DUYURU KOMUTU
# ====================================================
@bot.command()
@commands.has_permissions(administrator=True)
async def dmduyuru(ctx, *, mesaj: str):
    count = 0
    for member in ctx.guild.members:
        if member.bot:
            continue
        try:
            await member.send(mesaj)
            count += 1
        except:
            pass
    await ctx.send(f"âœ… Mesaj {count} kiÅŸiye DM olarak gÃ¶nderildi.")

# ====================================================
# OTOMATÄ°K ROL + HOÅ GELDÄ°N
# ====================================================
@bot.event
async def on_member_join(member):
    role = discord.utils.get(member.guild.roles, name="â­ï¸ãƒ»Member")
    if role:
        try:
            await member.add_roles(role)
        except:
            pass

    embed = discord.Embed(
        title="ğŸ‰ HoÅŸ Geldin!",
        description=f"{member.mention} sunucuya Ä±ÅŸÄ±k gibi dÃ¼ÅŸtÃ¼!",
        color=0x00ffae
    )
    embed.set_thumbnail(url=member.display_avatar)
    embed.add_field(name="Verilen Rol:", value="â­ï¸ãƒ»Member")

    log_ch = discord.utils.get(member.guild.text_channels, name="log-kankiÌ‡-bura")
    if log_ch:
        await log_ch.send(embed=embed)

# ====================================================
# TICKET SÄ°STEMÄ°
# ====================================================
class CloseTicketView(discord.ui.View):
    def __init__(self, channel):
        super().__init__(timeout=None)
        self.channel = channel

    @discord.ui.button(label="Kapat", style=discord.ButtonStyle.red, emoji="ğŸ”’")
    async def close_ticket(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_message("Ticket kapanÄ±yor...", ephemeral=True)
        await self.channel.delete()

class TicketView(discord.ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    async def get_or_create_ticket_channel(self, interaction: discord.Interaction, message_text: str):
        guild = interaction.guild
        category_name = "ãƒ»OwOãƒ»"
        channel_name = f"ãƒ»ğŸŒ™ãƒ»destek-{interaction.user.name}"

        category = discord.utils.get(guild.categories, name=category_name)
        if not category:
            category = await guild.create_category(category_name)

        existing_channel = discord.utils.get(category.channels, name=channel_name)
        if existing_channel:
            await existing_channel.send(message_text)
            return existing_channel

        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            interaction.user: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }

        channel = await guild.create_text_channel(channel_name, category=category, overwrites=overwrites)
        close_view = CloseTicketView(channel)
        await channel.send(f"{interaction.user.mention} ticket oluÅŸturuldu! AÅŸaÄŸÄ±daki butonla kapatabilirsin.", view=close_view)
        await channel.send(message_text)
        return channel

    @discord.ui.button(label="Oyuncu Åikayeti", style=discord.ButtonStyle.danger, emoji="âš ï¸")
    async def oyuncu_sikayeti(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_message("Ticket aÃ§Ä±ldÄ±, Ã¶zel kanal oluÅŸturuluyor...", ephemeral=True)
        await self.get_or_create_ticket_channel(interaction, f"{interaction.user.mention} yeni bir Oyuncu Åikayeti oluÅŸturdu!")

    @discord.ui.button(label="Genel Sorular", style=discord.ButtonStyle.primary, emoji="â“")
    async def genel_sorular(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_message("Ticket aÃ§Ä±ldÄ±, Ã¶zel kanal oluÅŸturuluyor...", ephemeral=True)
        await self.get_or_create_ticket_channel(interaction, f"{interaction.user.mention} yeni bir Genel Sorular ticket'Ä± aÃ§tÄ±!")

    @discord.ui.button(label="YÃ¶netici BaÅŸvurusu", style=discord.ButtonStyle.success, emoji="ğŸ“")
    async def yonetici_basvuru(self, interaction: discord.Interaction, button: discord.ui.Button):
        await interaction.response.send_message("Ticket aÃ§Ä±ldÄ±, Ã¶zel kanal oluÅŸturuluyor...", ephemeral=True)
        await self.get_or_create_ticket_channel(interaction, f"{interaction.user.mention} yeni bir YÃ¶netici BaÅŸvurusu ticket'Ä± aÃ§tÄ±!")

# ====================================================
# BOT READY + OTOMATÄ°K TICKET MESAJI
# ====================================================
@bot.event
async def on_ready():
    print("\n" + "â•" * 40)
    print(f"âœ… BOT AKTÄ°F: {bot.user}")
    print(f"ğŸŒ Sunucu sayÄ±sÄ±: {len(bot.guilds)}")
    print("â•" * 40 + "\n")

    guild = bot.guilds[0]
    category = discord.utils.get(guild.categories, name="ãƒ»OwOãƒ»")
    if not category:
        category = await guild.create_category("ãƒ»OwOãƒ»")

    channel = discord.utils.get(category.channels, name="ãƒ»ğŸŒ™ãƒ»destek")
    if not channel:
        channel = await guild.create_text_channel("ãƒ»ğŸŒ™ãƒ»destek", category=category)

    view = TicketView()
    ticket_message = "OwO SARP Ticket OluÅŸtur\nHizmet Saatleri: 18.00 - 21.00"
    await channel.send(ticket_message, view=view)

# ====================================================
bot.run(TOKEN)
